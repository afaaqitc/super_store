---
title: "Super Store Report"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)

#Super Store Project 

library(scales)
library(tidyr)
library(lubridate)
library(dplyr)
library(tibble)
library(formattable)
library(data.table)
library(stringr)
library(ggplot2)
library(GGally)
library(plotly)
library(fedmatch)
library(janitor)
library(gt)
library(DT)
library(pacman)
library(openxlsx)
library(readxl)
library(tseries)
library(forecast)

#-----------------Load------------------------------------------------

dd<-read.csv("~/Desktop/store/data_store.csv")

dd<-dd %>%mutate(order_date=as.POSIXct(order_date),ship_date=as.POSIXct(ship_date))

dd<-
dd%>% mutate(years=year(order_date))%>% 
mutate(order_date=as.Date(order_date),ship_date=as.Date(ship_date)) %>% 
mutate(wk=round_date(order_date,"week"),mn=round_date(order_date,"month")) %>%
mutate(month_year=paste(format(order_date,"%b"),year(order_date),sep = "_"),
week_month=paste(week(order_date),format(order_date,"%b"),sep = "_")) %>% 
mutate(ship_period=ship_date-order_date,days=weekdays(order_date))  
#----------------------------------------------------------------------

daily_sales<-
dd %>% group_by(order_date) %>% summarize(orders=n(),quantites=sum(qty),sales=sum(sales),profits=sum(profits)) %>% 
arrange(order_date)


#-----------------------------------------------------------------------------------------
ship_modes<-
dd %>% group_by(ship_mode,years) %>% summarize(orders=n(),quantities=sum(qty),
sales=round(sum(sales),2),profits=sum(profits),.groups = "drop") %>% mutate(years=as.factor(years))

ship_modes_chart<-
dd %>% group_by(ship_mode) %>% summarize(sales=comma(sum(sales))) %>% ggplot(aes(x="",y=sales,fill =ship_mode))+geom_bar(stat = "identity")+coord_polar(theta = "y")+theme_void()+geom_text(aes(label = sales),position = position_stack(vjust = 0.5),color="white")+scale_fill_brewer(palette = "Set1")

ship_modes_dt<-
ship_modes %>% select(years,ship_mode,orders,quantities,sales,profits) %>%
mutate(years=as.character(years)) %>% rename_with(.cols = everything(),.fn = toupper) %>%adorn_totals("row") %>%  
datatable(class="hover row-border",extensions = list(Buttons=TRUE,RowGroup=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","pdf","excel"),
rowGroup=list(dataSrc=c(2)),
columnDefs=list(list(className="dt-center",targets=c(1:6)),list(visible=FALSE,targets=c(2))))) %>% 
formatCurrency(columns = c(3:6),digits = 2)


#-----------------------------------------------------------------------------------------

segment_totals<-                                                  
dd %>% group_by(segment,years) %>% summarize(orders=n(),quantities=sum(qty),
sales=round(sum(sales),2),profits=sum(profits)) 

segment_totals_chart<-
segment_totals %>%mutate(years=factor(years)) %>%
ggplot(aes(x=years,y=sales,color=segment,group=segment))+geom_line(size=0.8)+geom_area(aes(fill=segment))+
scale_y_continuous(labels =  comma,breaks = c(100000,200000,300000,400000,500000,600000))+theme_bw()+labs(x="",y="")+
theme(axis.text.x = element_text(face = "bold",size = 10,colour = "black"),
      axis.text.y = element_text(face = "bold",size = 10,colour = "black"))+scale_fill_brewer(palette = "Set1")

segment_totals_dt<-
segment_totals %>% 
select(years,segment,orders,quantities,sales,profits) %>%
mutate(years=as.character(years)) %>% rename_with(.cols = everything(),.fn = toupper) %>%
adorn_totals("row") %>%  
datatable(class="hover row-border",extensions = list(Buttons=TRUE,RowGroup=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","pdf","excel"),
rowGroup=list(dataSrc=c(2)),
columnDefs=list(list(className="dt-center",targets=c(1:6)),list(visible=FALSE,targets=c(2))))) %>% 
formatCurrency(columns = c(3:6),digits = 2)


#-----------------------------------------------------------------------------------------
state_sales<-
dd %>% group_by(states,city) %>% 
summarize(orders=n(),quantities=sum(qty),sales=sum(sales),profits=sum(profits)) %>% 
arrange(desc(sales))



customers_sales<-
dd %>% group_by(customer_name) %>% 
summarize(orders=n(),quantities=sum(qty),sales=sum(sales),profits=sum(profits)) %>% 
arrange(desc(sales))%>% 
mutate(class=case_when(sales>10000 ~ "A",sales>1000 ~ "B",sales>500 ~ "C",TRUE ~ "D")) 

#---------------------------------------------------------------------------------------------------
category_orders<-
dd %>% group_by(categories,sub_categories) %>% 
summarize(orders=n(),quantities=sum(qty),sales=sum(sales),
profits=sum(profits),pct=sum(profits)/sum(sales)) %>% 
arrange(categories,sub_categories) %>%
mutate(class=case_when(pct>0.25 ~ "A",pct >0.1 ~ "B",TRUE~"C")) 


category_orders_chart<-
dd %>% mutate(years=factor(years))%>% group_by(categories,years) %>% 
summarize(sales=sum(sales),.groups = "drop") %>%
arrange( desc(sales)) %>% 
ggplot(aes(x=categories,y=sales,fill=years))+geom_bar(stat = "identity",position = "dodge")+
labs(x="",y="")+theme_bw()+scale_fill_brewer(palette = "Dark2")+
theme(axis.text.x = element_text(face = "bold",size=9,color="black"),
      axis.text.y = element_text(face = "bold",size=9,color="black"))+
scale_y_continuous(labels = comma,)

 

category_orders_dt<-
dd %>% group_by(categories,years) %>% 
summarize(sales=round(sum(sales)),.groups = "drop") %>%
arrange( desc(sales)) %>%  
pivot_wider(id_cols =categories ,names_from = years,values_from = sales,values_fill = FALSE) %>% 
select(categories,"2014","2015","2016","2017")%>%adorn_totals("col") %>% 
rename(Y14="2014",Y15="2015",Y16="2016",Y16="2016",Y17="2017") %>%  
datatable(class="hover row-border",
extensions = list(Buttons=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),columnDefs=list(list(className="dt-center",targets=c(1))))) %>% formatCurrency(columns = c(2:6),digits = 2)

category_orders_main_chart<-
dd %>% group_by(categories) %>% summarize(sales=sum(sales),.groups = "drop") %>% 
ggplot(aes(x="",y=sales,fill=categories))+geom_bar(stat = "identity")+coord_polar(theta = "y")+
theme_void()+geom_text(aes(label = comma(sales)),size=5,color="white",fontface = "bold",position = position_stack(vjust = 0.5))

items_classes_top<- 
category_orders %>% select(sub_categories,class) %>% 
left_join(dd,by="sub_categories") %>% 
group_by(class,categories.x,sub_categories,product_name) %>% summarize(quantities=sum(qty),
sales=sum(sales)) %>%  filter(class %in% c("A","B")) 


#------------------------------------------------------------------------------------------------------

date_map_sales<-
dd %>% mutate(weekn=week(order_date),monthn=month(order_date)) %>% 
group_by(years,monthn,weekn,week_month,days) %>% summarize(sales=sum(sales),.groups = "drop") %>% 
arrange(years,weekn) %>% select(years,week_month,days,sales) %>% 
pivot_wider(id_cols = c(years,week_month),names_from = days,values_from = sales,values_fill = FALSE)  %>% 
adorn_totals("col") %>%select(years,week_month,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday,Total)

date_map_sales_dt<-
date_map_sales %>% datatable(class="hover row-border",
extensions = list(Buttons=TRUE,RowGroup=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),rowGroup=list(dataSrc=c(1)),
columnDefs=list(list(className="dt-center",targets=c(1:10)),list(visible=FALSE,targets=1))))

ym_sales_chart<-
dd %>% mutate(years=factor(years),
months=factor(format(order_date,"%B"),levels = c("January","February","March","April","May","June","July",
"August","September","October","November","December")))%>% 
group_by(months,years) %>% summarize(sales=sum(sales),.groups = "drop") %>% arrange(years) %>% 
ggplot(aes(x=months,y=sales,color=years,group=years))+geom_line(size=0.8)+
theme_classic()+
theme(axis.text.x = element_text(face = "bold",colour = "black",size = 10),
      axis.text.y = element_text(face = "bold",colour = "black",size = 10)) +labs(x="",y="")+
scale_y_continuous(labels = comma)



#------------------------------------------------------------------------------------------------------

# Forecast Models

# Weekly

weekly_sales<- dd%>% group_by(wk) %>% summarize(sales=sum(sales))

train_data<-weekly_sales[c(1:156),]

detect_data<-weekly_sales[c(157:209),]

wk_ts<-ts(weekly_sales$sales,start = c(2014,1),end =c(2016,12) ,frequency = 52)

wk_dets<-ets(wk_ts)
wk_dar<-auto.arima(wk_ts)


wk_df<-forecast(wk_dets,h = 52)
wk_dff<-forecast(wk_dar,h = 53,level = c(95)) 


detect_model<-
cbind(detect_data,
rownames_to_column(data.frame(wk_dff)) %>% 
select(Point.Forecast,Hi.95) 
) %>% rename(date=wk,forecast=Point.Forecast)


detect_model_chart<-
detect_model %>% 
pivot_longer(!date,names_to ="cat" ,values_to ="values" ) %>% 
mutate(date=as.POSIXct(date)) %>% 
ggplot(aes(x=date,y=values))+geom_line(size=1.2)+
labs(x="",y="")+scale_x_datetime(date_breaks ="month" ,date_labels = "%b-%y")+
geom_area(aes(fill=cat))+scale_fill_brewer(palette = "Set6")+theme_classic()+
theme(axis.text.x = element_text(face = "bold",colour = "black",size = 9),
      axis.text.y = element_text(face = "bold",colour = "black",size = 9))

detect_model_dt<-
detect_model %>%rename_with(.cols = everything(),.fn = toupper) %>% 
datatable(class="hover row-border",
extensions = list(Buttons=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),
columnDefs=list(list(className="dt-center",targets=c(1:4))))) %>% 
formatCurrency(columns = c(2:4),digits = 2)

# Weekly Real 

wk_rts<-ts(weekly_sales$sales,start = c(2014,1),frequency = 52)

wk_rar<-auto.arima(wk_rts)
wk_rets<-ets(wk_rts)

wk_rets_f<-forecast(wk_rts,h = 53)
wk_rar_f<-forecast(wk_rts,h = 53)

 
weekly_real_forecast<-
cbind( 
data_frame(date=seq(as.Date("2018-1-1"),len=53,by="week")) 
,rownames_to_column(data.frame( wk_rets_f)) %>% select(2:6)) %>% 
mutate(Hi=(Hi.95+Hi.80)/2,Low=(Lo.95+Lo.80)/2) %>% 
select(date,Point.Forecast,Hi,Low)

weekly_real_forecast_chart<-
weekly_real_forecast %>%select(date,Low,Hi,Point.Forecast) %>% 
pivot_longer(!date,names_to = "cat",values_to = "values") %>%
mutate(date=as.POSIXct(date))%>% 
ggplot(aes(x=date,y=values,color=cat,group=cat))+geom_line(size=0.8)+geom_area(aes(fill=cat))+
theme(axis.text.x = element_text(face = "bold",colour = "black",angle = 90,size = 9),
axis.text.y = element_text(face = "bold",colour = "black",angle = 90,size = 9))+
scale_fill_brewer(palette = "Set1")+
scale_x_datetime(date_breaks ="2 week" ,date_labels = "%b%Y")+theme_classic()+
labs(x="",y="")+
scale_y_continuous(breaks = c(5000,10000,15000,20000,25000,30000,35000,40000))

  
weekly_real_forecast_dt<-
weekly_real_forecast %>% 
mutate(date=paste0("W",week=week(date)," ",format(date,"%b")," ",year(date)))%>% 
datatable(class="hover row-border",
extensions = list(Buttons=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),
columnDefs=list(list(className="dt-center",targets=c(1:4))))) %>% 
formatCurrency(columns = c(2:4),digits = 2) 

#-----------------------------------------------------------------------------

# Monthly

mn<-
dd %>% group_by(mn) %>% summarize(sales=sum(sales))
  
mn_train<-mn[c(1:37),]
mn_test<-mn[c(38:49),]
  
  
mn_dts<-ts(mn$sales,start =c(2014,1) ,end =c(2017,1) ,frequency = 12)  
   
mn_dets<-ets(mn_dts)  
mn_dar<-auto.arima(mn_dts)

mn_df<-forecast(mn_dets,h = 12,level = c(95))  
mn_dfor<-forecast(mn_dar,h = 12,level = c(95))
 
monthly_detect<-
cbind(
mn_test
,
rownames_to_column(data.frame(mn_dfor)) %>% 
select(2:4)) %>%
rename(date=mn,p.forecast=Point.Forecast) %>% 
mutate(date=as.POSIXct(date))

monthly_detect_chart<-
monthly_detect %>% 
pivot_longer(!date,names_to ="Forecast" ,values_to = "values") %>% 
mutate(date=as.POSIXct(date)) %>% filter(Forecast != c("Lo.95","Hi.95")) %>% 
ggplot(aes(x=date,y=values))+
geom_line(size=0.9)+geom_area(aes(fill=Forecast))+
theme_bw()+
scale_x_datetime(date_breaks ="month" ,date_labels = "%b %y")+
scale_y_continuous(labels =  comma)+labs(x="",y="")+
theme(axis.text.x = element_text(colour = "black",face = "bold",size = 10),
axis.text.y = element_text(colour = "black",face = "bold",size = 10))+
scale_fill_brewer(palette = "Set1")


monthly_detect_dt<-
monthly_detect %>% 
mutate(date=as.Date(date))%>%
rename_with(.cols = c(1:5),.fn = toupper) %>% 
adorn_totals("row") %>% 
datatable(class="hover row-border",
extensions = list(Buttons=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),
columnDefs=list(list(className="dt-center",targets=c(1:5))))) %>% 
formatCurrency(columns = c(2:5),digits = 2)


# Monthly Real 
mn_rts<-ts(mn$sales,start = c(2014,1),frequency = 12)
mn_ets<-ets(mn_rts)
mn_f1<-forecast(mn_ets,h = 12,level = c(95))


mn_ar<-auto.arima(mn_rts)
mn_f2<-forecast(mn_ar,h = 12,level = c(95))
 
Month_Forecast<-
cbind(data.frame(date=seq(as.Date("2018-2-1"),len=12,by="month")),
rownames_to_column(data.frame(mn_f2)) %>%
mutate(my=as.factor(rowname)) %>% select(5,2:4)) %>% select(1,3:5)

Month_Forecast_chart<-
Month_Forecast %>%
pivot_longer(!date,names_to ="Forecast" ,values_to = "values") %>% 
filter(Forecast !="Hi.95") %>%mutate(date=as.POSIXct(date)) %>% 
ggplot(aes(x=date,y=values,color=Forecast,group=Forecast))+
geom_line(size=0.9)+labs(x="",y="")+
theme_bw()+scale_fill_brewer(palette = "Set1")+
theme(axis.text.x = element_text(face = "bold",colour = "black",size = 10),
axis.text.y = element_text(face = "bold",colour = "black",size = 10))+
scale_x_datetime(date_breaks = "month",date_labels = "%b %y")+
geom_area(aes(fill=Forecast))


Month_Forecast_dt<-
Month_Forecast %>%
rename_with(.cols =c(2:4) ,.fn = toupper)%>% 
datatable(class="hover row-border"
,extensions = list(Buttons=TRUE),
options = list(dom="Bfrtip",buttons=c("csv","excel","pdf"),
columnDefs=list(list(className="dt-center",targets=c(1:4))))) %>% 
formatCurrency(columns = c(2:4),digits = 2)

```

# Main
## row{data-width=5}

### Sales
```{r}
valueBox(value =comma(sum(dd$sales)) ,caption = "Sales",color = "#dcdde1")
```


### Profits
```{r}
valueBox(value =comma(sum(dd$profits)) ,caption = "Profits",color = "#dcdde1")

```

### Quantiities
```{r}
valueBox(value =comma(sum(dd$qty)) ,caption = "Quantites",color = "#dcdde1")

```

### Items
```{r}
valueBox(value =comma(dd %>% select(product_name) %>% unique() %>% nrow()) ,caption ="Items" ,color ="#dcdde1" )
```


## row{data-hight=440,.tabset}
### Categories
```{r}
category_orders_dt
```

### Chart
```{r}
ggplotly( category_orders_chart,width=600)
```

# Sales Dates
## row{.tabset}
### Year_month
```{r}
date_map_sales_dt %>%formatCurrency(columns = c(2:9),digits = 2)
```


### Chart
```{r}
ggplotly( ym_sales_chart,width=1000)

```



# Segments
## row{.tabset}
### Segments
```{r}
segment_totals_dt
```

### Chart 
```{r}
ggplotly( segment_totals_chart,width=1000)
```

# Ship_Modes
## row{data-width=500,.tabset}
### TBL
```{r}
ship_modes_dt
```

### Chart
```{r}
ship_modes_chart
```


# Forecasting_Models
## row{.tabset}
### Weekly_Detect_Model
```{r}
detect_model_dt
```

### Weekly_Detect_Chart
```{r}
ggplotly( detect_model_chart ,width = 1000)
```

### Weekly Next Year Model
```{r}
weekly_real_forecast_dt
```


### Weekly Real Chart
```{r}
ggplotly( weekly_real_forecast_chart,width=1000)
```



### Monthly Detect Last Year
```{r}
monthly_detect_dt
```

### Monthly Detect chart
```{r}
ggplotly( monthly_detect_chart,width=1000)
```


### Monthly Forecast Next Year
```{r}
Month_Forecast_dt
```

### Monthly Next Year Chart
```{r}
ggplotly( Month_Forecast_chart,width=1000)

```

